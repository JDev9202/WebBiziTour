<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Malaga BiziTour Agreement Form</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <style>
    :root {
      --primary: #0066cc;
      --primary-light: #3399ff;
      --accent: #00cc99;
      --bg-gradient: linear-gradient(135deg, #e0f7fa, #e8eaf6);
      --card-bg: #ffffff;
      --text: #333333;
      --muted: #666666;
      --radius: 16px;
      --shadow: 0 10px 30px rgba(0,0,0,0.1);
      --spacing: 1.5rem;
      --transition: 0.3s ease;
    }

    .spinner {
  border: 3px solid #f3f3f3; /* Gris claro */
  border-top: 3px solid #3498db; /* Azul */
  border-radius: 50%;
  width: 16px;
  height: 16px;
  animation: spin 1s linear infinite;
  display: inline-block;
  margin-left: 10px;
  vertical-align: middle;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: url('gavia-XCWIec2ySp4-unsplash.jpg') no-repeat center center fixed;
      background-size: cover;
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 2rem;
      min-height: 100vh;
    }
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 640px;
      overflow: hidden;
      animation: fadeIn 0.6s var(--transition);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .header {
      background: var(--primary);
      padding: var(--spacing);
      text-align: center;
      color: #fff;
    }
    .header img {
      max-width: 100px;
      margin-bottom: 0.5rem;
    }
    .header h2 {
      font-weight: 700;
      margin: 0;
      font-size: 1.75rem;
    }
    #intro {
      padding: var(--spacing);
      text-align: center;
    }
    #intro h2 {
      color: var(--primary);
      margin-bottom: 0.5rem;
    }
    #intro p {
      color: var(--muted);
      line-height: 1.5;
    }
    #next-btn {
      margin-top: var(--spacing);
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      padding: 0.75rem 2rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background var(--transition);
    }
    #next-btn:hover { background: var(--primary); }
    #form-container { display: none; padding: var(--spacing); }
    form { display: flex; flex-direction: column; }

    /* separaci√≥n extra entre los botones */
    #add-participant-btn {
      margin-bottom: var(--spacing);
    }

    .participant {
      background: #f9f9f9;
      border-radius: var(--radius);
      border: 1px solid #eee;
      margin-bottom: var(--spacing);
      padding: var(--spacing);
      position: relative;
      transition: transform var(--transition);
    }
    .participant:hover { transform: translateY(-5px); }
    .participant h3 { margin-top: 0; color: var(--primary); }
    .remove-participant-btn {
      position: absolute; top: var(--spacing); right: var(--spacing);
      background: #ff4d4d; color: #fff; border: none;
      border-radius: var(--radius); padding: 0.25rem 0.5rem;
      font-size: 0.8rem; cursor: pointer; transition: background var(--transition);
    }
    .remove-participant-btn:hover { background: #e60000; }
    .form-group { margin-bottom: var(--spacing); }
    label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="date"] {
      width: 100%; padding: 0.75rem; border: 1px solid #ddd;
      border-radius: var(--radius); font-size: 1rem;
      transition: border-color var(--transition);
    }
    input:focus { outline: none; border-color: var(--primary-light); }
    input:invalid { border-color: red; }

    /* ESTILO DEL ACUERDO */
    #agreement-content {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      padding: var(--spacing);
      max-height: 240px;
      overflow-y: auto;
      margin-bottom: var(--spacing);
      line-height: 1.5;
    }
    #agreement-content.disabled {
      pointer-events: none;
      opacity: 0.6;
    }
    #agreement-content h4 {
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      color: var(--primary);
      font-weight: 600;
    }
    #agreement-content p,
    #agreement-content li {
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    .checkbox-group { display: flex; align-items: center; gap: 0.5rem; margin-bottom: var(--spacing); }

    /* Canvas signature: solo touch-action */
    canvas.signature-pad {
      width: 100%;
      height: 150px;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      background: #fff;
      touch-action: none;
    }

    .signature-buttons { display: flex; gap: var(--spacing); margin-top: 0.5rem; }
    .btn {
      background: var(--primary); color: #fff; padding: 0.75rem 1.5rem;
      border: none; border-radius: var(--radius); font-size: 1rem;
      cursor: pointer; transition: background var(--transition), transform var(--transition);
    }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    .btn:not(:disabled):hover { background: var(--primary-light); transform: translateY(-2px); }

    /* MODAL DE AGRADECIMIENTO */
    #thankyou-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    #thankyou-modal .modal-content {
      background: #fff;
      border-radius: var(--radius);
      padding: var(--spacing);
      max-width: 400px;
      text-align: center;
      box-shadow: var(--shadow);
    }
    #thankyou-modal .modal-content h3 {
      margin-top: 0;
      color: var(--primary);
    }
    #thankyou-modal .modal-content .modal-buttons {
      margin-top: var(--spacing);
      display: flex;
      gap: var(--spacing);
      justify-content: center;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <img src="bicitourlogo.png" alt="BiziTour M√°laga Logo">
      <h2>Malaga BiziTour Agreement Form</h2>
    </div>
    <div id="intro">
      <h2>Welcome to BiziTour M√°laga!</h2>
      <p>We're delighted to provide you with a bicycle tour to explore our beautiful city. To ensure a smooth and enjoyable experience, please review and agree to the following terms:</p>
      <button id="next-btn">Next</button>
    </div>
    <div id="form-container">
      <form id="form">
        <div id="participants-container"></div>
        <button type="button" id="add-participant-btn" class="btn" disabled>Add Participant</button>
        <button type="submit" class="btn" disabled>Submit All</button>
      </form>
    </div>
  </div>

  <!-- Plantilla de participante -->
  <template id="participant-template">
    <div class="participant">
      <h3>Participant <span class="index"></span></h3>
      <button type="button" class="remove-participant-btn">Remove</button>
      <div class="form-group"><label>First Name</label><input type="text" name="firstName" required></div>
      <div class="form-group"><label>Last Name</label><input type="text" name="lastName" required></div>
      <div class="form-group"><label>Email</label><input type="email" name="email" required></div>
      <div class="form-group">
        <label>Phone</label>
        <input type="tel" name="phone" inputmode="tel" placeholder="+34 600123456"
               pattern="^\+?[0-9 ]{7,15}$" required>
      </div>
      <div class="form-group"><label>Date</label><input type="date" name="date" required></div>
      <div class="form-group">
        <div id="agreement-content">
          <h4>BICYCLE TOUR PARTICIPATION AGREEMENT</h4>
          <p>This agreement governs participation in a bike tour organized by <strong>BIZITOUR</strong>, a trademark of Digoo Design S.L. (CIF: B67988410), hereinafter referred to as "the Organizer," and the participant, hereinafter referred to as "the Client."</p>
          <h4>1. Purpose of the Agreement</h4>
          <p>The Client agrees to participate in a guided bike tour organized by the Organizer, which includes the use of a bicycle, helmet, and accessories (if applicable). The tour details, including route and duration, have been communicated in advance.</p>
          <h4>2. Client Responsibilities</h4>
          <ul>
            <li>Follow the guide‚Äôs instructions at all times.</li>
            <li>Use the safety equipment provided.</li>
            <li>Respect traffic laws and act prudently during the tour.</li>
            <li>Assume responsibility for any damages caused to third parties, the equipment, or themselves due to negligence or failure to comply with regulations.</li>
          </ul>
          <h4>3. Organizer Responsibilities</h4>
          <ul>
            <li>Ensure that bicycles and accessories are in optimal condition.</li>
            <li>Provide a qualified guide to lead the tour safely.</li>
            <li>Provide assistance in case of mechanical issues or problems during the tour.</li>
          </ul>
          <h4>4. Liability Waiver</h4>
          <ul>
            <li>The Organizer shall not be held responsible for injuries, accidents, or damages caused by the Client‚Äôs negligence.</li>
            <li>Loss of personal belongings during the tour.</li>
            <li>Tour cancellations or modifications due to adverse weather conditions or force majeure.</li>
          </ul>
          <h4>5. Cancellations and Refunds</h4>
          <ul>
            <li>Cancellations by the Client made at least 48 hours in advance are eligible for a full refund.</li>
            <li>Cancellations made less than 48 hours in advance will not be refunded.</li>
            <li>The Organizer reserves the right to modify or cancel the tour for safety reasons, offering rescheduling or a refund.</li>
          </ul>
          <h4>6. Data Protection</h4>
          <p>The Client agrees to the use of their personal data solely for the management of the tour, in compliance with GDPR regulations.</p>
          <h4>7. Jurisdiction</h4>
          <p>This agreement is governed by the laws of Spain, with both parties submitting to the courts of the Organizer's registered location.</p>
          <p><em>"By signing this agreement, the undersigned represents and accepts responsibility for the entire group of participants, who agree to abide by the terms herein."</em></p>
          <h4>8. Group Participation Clause</h4>
          <p>In the case of group tours, the Group Leader signs this agreement on behalf of all participants, certifying that they have been informed of and agree to the stated terms. The Group Leader assumes responsibility for any violations by the group members. A participant list must be provided to the organizer, and if required, each member may sign their individual acceptance separately.</p>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" name="agree" disabled>
          <label>I have read and agree to the Terms &amp; Conditions</label>
        </div>
      </div>
      <div class="form-group">
        <label>Signature</label>
        <canvas class="signature-pad"></canvas>
        <div class="signature-buttons">
          <button type="button" class="btn confirm-signature-btn" disabled>Confirm Signature</button>
          <button type="button" class="btn clear-signature-btn" disabled>Clear Signature</button>
        </div>
      </div>
    </div>
  </template>

  <!-- Modal de agradecimiento -->
  <div id="thankyou-modal" class="flex">
    <div class="modal-content">
      <h3>Your information was successfully submitted. Thanks!</h3>
      <div class="modal-buttons">
        <button id="finish-btn" class="btn">Finish</button>
      </div>
    </div>
  </div>

  <script>
    const intro = document.getElementById('intro');
    const formContainer = document.getElementById('form-container');
    const nextBtn = document.getElementById('next-btn');
    const container = document.getElementById('participants-container');
    const templateElem = document.getElementById('participant-template');
    const addBtn = document.getElementById('add-participant-btn');
    const submitBtn = document.querySelector('form button[type="submit"]');
    const modal = document.getElementById('thankyou-modal');
    const finishBtn = document.getElementById('finish-btn');
    const emailCopyBtn = document.getElementById('email-copy-btn');

    let count = 0, signaturePads = [], signatureAccepted = [];

    function isSignatureValid(signaturePad) {
  if (signaturePad.isEmpty()) {
    return false; // El lienzo est√° completamente vac√≠o
  }
  
  const dataUrl = signaturePad.toDataURL();
  const minDataUrlLength = 5000; // Ajustable: m√≠nimo de datos para considerar v√°lida la firma
  
  if (dataUrl.length < minDataUrlLength) {
    return false; // La firma es demasiado peque√±a (ej: solo un puntito)
  }

  return true; // La firma parece razonable
}


    // Mostrar formulario inicial
    nextBtn.addEventListener('click', () => {
      intro.style.display = 'none';
      formContainer.style.display = 'block';
    });

    function updateAdd() {
      const parts = container.querySelectorAll('.participant');
      const last = parts[parts.length - 1];
      if (!last) return;
      const fields = last.querySelectorAll('input[type="text"],input[type="email"],input[type="tel"],input[type="date"]');
      const allValid = Array.from(fields).every(i => i.checkValidity());
      const checked = last.querySelector('input[name="agree"]').checked;
      const signed = signatureAccepted[signatureAccepted.length - 1];
      addBtn.disabled = !(allValid && checked && signed);
      updateSubmit();
    }

    function updateSubmit() {
      const parts = container.querySelectorAll('.participant');
      const ok = parts.length > 0 && Array.from(parts).every((p, i) => {
        const fields = p.querySelectorAll('input[type="text"],input[type="email"],input[type="tel"],input[type="date"]');
        return Array.from(fields).every(f => f.checkValidity())
          && p.querySelector('input[name="agree"]').checked
          && signatureAccepted[i];
      });
      submitBtn.disabled = !ok;
    }

    function addPart() {
      count++;
      const clone = templateElem.content.cloneNode(true);
      const part = clone.querySelector('.participant');
      part.querySelector('.index').innerText = count;
      if (count === 1) part.querySelector('.remove-participant-btn').style.display = 'none';
      container.appendChild(part);

      signatureAccepted.push(false);
      const idx = signatureAccepted.length - 1;
      part.querySelector('input[name="date"]').value = new Date().toISOString().split('T')[0];

      const canvasEl = part.querySelector('canvas.signature-pad');

      // 1) Calibrar el canvas seg√∫n DPR
      function resizeCanvas() {
        const ratio = window.devicePixelRatio || 1;
        canvasEl.width  = canvasEl.offsetWidth  * ratio;
        canvasEl.height = canvasEl.offsetHeight * ratio;
        canvasEl.getContext('2d').scale(ratio, ratio);
      }
      setTimeout(resizeCanvas, 0);
      window.addEventListener('resize', resizeCanvas);

      // 2) Crear SignaturePad
      const pad = new SignaturePad(canvasEl);
      signaturePads.push(pad);

      // 3) Bloquear canvas hasta que se marque checkbox
      canvasEl.style.pointerEvents = 'none';
      canvasEl.style.opacity       = '0.5';

      const agreeChk   = part.querySelector('input[name="agree"]');
      const confirmBtn = part.querySelector('.confirm-signature-btn');
      const clearBtn   = part.querySelector('.clear-signature-btn');
      const inputsAll  = part.querySelectorAll(
        'input[name="firstName"],input[name="lastName"],input[name="email"],input[name="phone"],input[name="date"]'
      );

      function checkInputs() {
        const ok = Array.from(inputsAll).every(i => i.checkValidity());
        agreeChk.disabled = !ok;
        if (!ok) agreeChk.checked = false;
        confirmBtn.disabled = true;
        clearBtn.disabled   = true;
        updateAdd();
      }
      inputsAll.forEach(i => i.addEventListener('input', checkInputs));
      checkInputs();

      agreeChk.addEventListener('change', () => {
        if (agreeChk.checked) {
          resizeCanvas();  
          canvasEl.style.pointerEvents = 'auto';
          canvasEl.style.opacity       = '1';
          confirmBtn.disabled = false;
          clearBtn.disabled   = false;
        } else {
          canvasEl.style.pointerEvents = 'none';
          canvasEl.style.opacity       = '0.5';
          confirmBtn.disabled = true;
          clearBtn.disabled   = true;
          pad.clear();
        }
        updateAdd();
      });

      pad.onEnd = updateAdd;
      clearBtn.addEventListener('click', () => {
        pad.clear();
        signatureAccepted[idx] = false;
        updateAdd();
      });
      confirmBtn.addEventListener('click', () => {
  if (!isSignatureValid(pad)) {
    alert('Please provide a complete and valid signature before confirming.');
    return; // üö´ Detener si la firma es inv√°lida
  }

  // üîµ Si pasa la validaci√≥n, contin√∫a todo normal
  signatureAccepted[idx] = true;
  part.querySelector('#agreement-content').classList.add('disabled');
  pad.off();
  confirmBtn.disabled = true;
  clearBtn.disabled = true;
  part.querySelectorAll('input, .remove-participant-btn').forEach(el => el.disabled = true);
  updateAdd();
});


      part.querySelector('.remove-participant-btn').addEventListener('click', () => {
        signaturePads.splice(idx, 1);
        signatureAccepted.splice(idx, 1);
        container.removeChild(part);
        updateAdd();
        updateSubmit();
      });

      updateAdd();
    }

    addBtn.addEventListener('click', addPart);
    addPart();

    document.getElementById('form').addEventListener('submit', async e => {
  e.preventDefault();

  // Desactivar el bot√≥n y agregar spinner
  submitBtn.disabled = true;
  submitBtn.innerHTML = 'Procesando... <div class="spinner"></div>';

  const participants = Array.from(container.children).map((part, i) => ({
    firstName: part.querySelector('input[name="firstName"]').value,
    lastName : part.querySelector('input[name="lastName"]').value,
    email    : part.querySelector('input[name="email"]').value,
    phone    : part.querySelector('input[name="phone"]').value,
    date     : part.querySelector('input[name="date"]').value,
    agree    : part.querySelector('input[name="agree"]').checked,
    signature: signaturePads[i].toDataURL()
  }));

  try {
    const res = await fetch('/submit', {
      method : 'POST',
      headers: { 'Content-Type': 'application/json' },
      body   : JSON.stringify({ participants })
    });
    const data = await res.json();
    if (data.ok) {
      modal.style.display = 'flex';
    } else {
      alert('Error sending: ' + data.error);
      submitBtn.disabled = false;
      submitBtn.innerText = "Submit All";
    }
  } catch {
    alert('Network error.');
    submitBtn.disabled = false;
    submitBtn.innerText = "Submit All";
  }
});



finishBtn.addEventListener('click', () => {
  modal.style.display = 'none';
  container.innerHTML = '';
  signaturePads = [];
  signatureAccepted = [];
  count = 0;
  addPart();
  formContainer.style.display = 'none';
  intro.style.display = 'block';

  // üîµ Restaurar bien el bot√≥n Submit All
  submitBtn.disabled = true;
  submitBtn.innerHTML = "Submit All"; // ‚úÖ Esto borra tambi√©n el spinner
});



    emailCopyBtn.addEventListener('click', () => {
      alert('Email copy functionality not implemented yet.');
    });
  </script>
</body>
</html>
